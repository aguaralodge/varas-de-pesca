<input id="pName" placeholder="Nombre" />
<input id="pPrice" type="number" placeholder="Precio" />
<input id="pStock" type="number" placeholder="Stock" />
<input id="pCat" placeholder="Categoría" />
<textarea id="pDesc" placeholder="Descripción completa"></textarea>
<input id="pImg" type="file" accept="image/*" />
<button id="btnSave" type="button">Guardar producto</button>
<div id="msg" style="margin-top:10px;"></div>

<script>
// Si ya tenés un lock, podés guardar la pass en sessionStorage con esta key.
// Si no existe, usa la hardcodeada de abajo.
const FALLBACK_PASSWORD = "EMIr1993";
function getAdminPassword(){
  try {
    return sessionStorage.getItem("admin_password") || FALLBACK_PASSWORD;
  } catch {
    return FALLBACK_PASSWORD;
  }
}

const $ = (id) => document.getElementById(id);

$("btnSave").addEventListener("click", async () => {
  const msg = $("msg");

  const name = $("pName").value.trim();
  const price = Number($("pPrice").value || 0);
  const stock = Number($("pStock").value || 0);
  const category = $("pCat").value.trim();
  const description = $("pDesc").value.trim();
  const file = $("pImg").files[0];

  if (!name) { msg.textContent = "Falta nombre"; return; }
  if (Number.isNaN(price) || price < 0) { msg.textContent = "Precio inválido"; return; }
  if (!Number.isInteger(stock) || stock < 0) { msg.textContent = "Stock inválido"; return; }

  let imageBase64 = null, imageMime = null;
  if (file) {
    imageMime = file.type || "image/jpeg";
    const dataUrl = await fileToBase64(file);
    imageBase64 = dataUrl.split(",")[1];
  }

  msg.textContent = "Guardando...";

  let r, j;
  try {
    r = await fetch("/api/products/create", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-admin-password": getAdminPassword()
      },
      body: JSON.stringify({ name, price, stock, category, description, imageBase64, imageMime })
    });
  } catch (e) {
    msg.textContent = "Error de red al llamar a la API: " + String(e);
    return;
  }

  try {
    j = await r.json();
  } catch {
    const t = await r.text().catch(()=> "");
    msg.textContent = "Respuesta inválida del servidor. Status " + r.status + " " + t;
    return;
  }

  if (!r.ok) {
    const detail = j?.detail
      ? (typeof j.detail === "string" ? j.detail : JSON.stringify(j.detail))
      : "";
    msg.textContent = `Error (${r.status}): ${j?.error || "Fallo"}${detail ? " | " + detail : ""}`;
    return;
  }

  msg.textContent = "Producto cargado ✅";

  // Limpieza rápida
  $("pName").value = "";
  $("pPrice").value = "";
  $("pStock").value = "";
  $("pCat").value = "";
  $("pDesc").value = "";
  $("pImg").value = "";
});

function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=> resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}
</script>
